<!-- TOC -->

- [v1.0.1_20180717_004](#v10120180717004)
  - [v1.0.1_20180717_004下载](#v10120180717004%E4%B8%8B%E8%BD%BD)
  - [v1.0.1_20180717_004信息](#v10120180717004%E4%BF%A1%E6%81%AF)
  - [主要更新](#%E4%B8%BB%E8%A6%81%E6%9B%B4%E6%96%B0)
    - [新功能](#%E6%96%B0%E5%8A%9F%E8%83%BD)
    - [改变](#%E6%94%B9%E5%8F%98)
- [v1.0.1_20180714_003](#v10120180714003)
  - [v1.0.1_20180714_003下载](#v10120180714003%E4%B8%8B%E8%BD%BD)
  - [v1.0.1_20180714_003信息](#v10120180714003%E4%BF%A1%E6%81%AF)
  - [主要更新](#%E4%B8%BB%E8%A6%81%E6%9B%B4%E6%96%B0)
    - [新功能](#%E6%96%B0%E5%8A%9F%E8%83%BD)
    - [改变](#%E6%94%B9%E5%8F%98)
- [v1.0.1_20180702_002](#v10120180702002)
  - [v1.0.1_20180702_002下载](#v10120180702002%E4%B8%8B%E8%BD%BD)
  - [v1.0.1_20180702_002信息](#v10120180702002%E4%BF%A1%E6%81%AF)
  - [主要更新](#%E4%B8%BB%E8%A6%81%E6%9B%B4%E6%96%B0)
    - [新功能](#%E6%96%B0%E5%8A%9F%E8%83%BD)
    - [改变](#%E6%94%B9%E5%8F%98)
  - [MR](#mr)
    - [修复的MR](#%E4%BF%AE%E5%A4%8D%E7%9A%84mr)
    - [未修复的MR](#%E6%9C%AA%E4%BF%AE%E5%A4%8D%E7%9A%84mr)
- [v1.0.1_20180619_001](#v10120180619001)
  - [v1.0.1_20180619_001下载](#v10120180619001%E4%B8%8B%E8%BD%BD)
  - [v1.0.1_20180619_001信息](#v10120180619001%E4%BF%A1%E6%81%AF)
  - [主要更新](#%E4%B8%BB%E8%A6%81%E6%9B%B4%E6%96%B0)
    - [新功能](#%E6%96%B0%E5%8A%9F%E8%83%BD)
    - [改变](#%E6%94%B9%E5%8F%98)
  - [Source Code](#source-code)
    - [Code结构](#code%E7%BB%93%E6%9E%84)
  - [安装](#%E5%AE%89%E8%A3%85)
    - [配置rtc](#%E9%85%8D%E7%BD%AErtc)
      - [rtc.yml](#rtcyml)
  - [升级](#%E5%8D%87%E7%BA%A7)
    - [From v1.0.0](#from-v100)
  - [工具](#%E5%B7%A5%E5%85%B7)
    - [setPrintSwitch.py](#setprintswitchpy)
- [v1.0.0_20180615_003](#v10020180615003)
  - [v1.0.0_20180615_003下载](#v10020180615003%E4%B8%8B%E8%BD%BD)
  - [v1.0.0_20180615_003信息](#v10020180615003%E4%BF%A1%E6%81%AF)
  - [MR](#mr)
    - [修复的MR](#%E4%BF%AE%E5%A4%8D%E7%9A%84mr)
    - [未修复的MR](#%E6%9C%AA%E4%BF%AE%E5%A4%8D%E7%9A%84mr)
- [v1.0.0_20180613_002](#v10020180613002)
  - [v1.0.0_20180613_002下载](#v10020180613002%E4%B8%8B%E8%BD%BD)
  - [v1.0.0_20180613_002信息](#v10020180613002%E4%BF%A1%E6%81%AF)
  - [主要更新](#%E4%B8%BB%E8%A6%81%E6%9B%B4%E6%96%B0)
    - [新功能](#%E6%96%B0%E5%8A%9F%E8%83%BD)
    - [改变](#%E6%94%B9%E5%8F%98)
- [v1.0.0_20180611_001](#v10020180611001)
  - [v1.0.0_20180611_001下载](#v10020180611001%E4%B8%8B%E8%BD%BD)
  - [v1.0.0_20180611_001信息](#v10020180611001%E4%BF%A1%E6%81%AF)
  - [References](#references)
  - [概述](#%E6%A6%82%E8%BF%B0)
  - [主要更新](#%E4%B8%BB%E8%A6%81%E6%9B%B4%E6%96%B0)
    - [新功能](#%E6%96%B0%E5%8A%9F%E8%83%BD)
    - [改变](#%E6%94%B9%E5%8F%98)
  - [MR](#mr)
    - [修复的MR](#%E4%BF%AE%E5%A4%8D%E7%9A%84mr)
    - [未修复的MR](#%E6%9C%AA%E4%BF%AE%E5%A4%8D%E7%9A%84mr)
  - [Source Code](#source-code)
    - [Code结构](#code%E7%BB%93%E6%9E%84)
    - [编译环境](#%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83)
  - [安装](#%E5%AE%89%E8%A3%85)
    - [安装JDK](#%E5%AE%89%E8%A3%85jdk)
    - [安装rtc](#%E5%AE%89%E8%A3%85rtc)
    - [配置rtc](#%E9%85%8D%E7%BD%AErtc)
      - [setEnv.sh](#setenvsh)
      - [rtc.yml](#rtcyml)
      - [logback.xml](#logbackxml)
    - [启动](#%E5%90%AF%E5%8A%A8)
  - [PROTOCOL CHART](#protocol-chart)

<!-- /TOC -->

---
# v1.0.1_20180717_004
---
## v1.0.1_20180717_004下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc_1.0.1_20180717_004.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc_1.0.1_20180717_004.tar.gz)|39dfa09b2330ab5fb41a66c2460af778aa00349b9b96d49850d4c2ae95a592b8|
|[rtc_1.0.1_20180717_004_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc_1.0.1_20180717_004_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.1_20180717_004信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年7月17日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： 1，处理探针json消息中value字段非字符串的情况。

---

## 主要更新

### 新功能

>* None

### 改变

>* 处理探针json消息中value字段非字符串的情况。

---
# v1.0.1_20180714_003
---
## v1.0.1_20180714_003下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc_1.0.1_20180714_003.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc_1.0.1_20180714_003.tar.gz)|629f453af00a6595fba3671dc8a6ee7b5d510709572a6cf5372dd5f026b8d3c7|
|[rtc_1.0.1_20180714_003_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc_1.0.1_20180714_003_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.1_20180714_003信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年7月14日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： 1，针对重庆探针异常消息进行修正

---

## 主要更新

### 新功能

>* None

### 改变

>* 1，针对重庆探针异常消息进行修正
>    * 删除除探针消息中的换行符
>    * 删除探针消息中json的value中的逗号
>    * 如果探针消息中json的value中包含```function Object()```，将value置为空字符串。
>    * 如果探针消息中json的value中包含```[native code]```，将value置为空字符串。

---

# v1.0.1_20180702_002
---
## v1.0.1_20180702_002下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc_1.0.1_20180702_002.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc_1.0.1_20180702_002.tar.gz)|13d0cab1a597db16162164803709661d310158c6d72c2a57fbd2423c4a43116a|
|[rtc_1.0.1_20180702_002_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc_1.0.1_20180702_002_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.1_20180702_002信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年7月2日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： 1,修复探针消息data处理之后没有返回处理过的data的bug；
2，支持南传探针heartbeat消息。

---

## 主要更新

### 新功能

>* 支持南传探针heartbeat消息/?opt=get&name=epglog1。以前flume返回500，现在rtc返回200 OK。

### 改变

>* None

---

## MR

### 修复的MR
| MR Num | 描述| 发现的版本 | 修复的版本 |
-------- | ----------- |------ | ------- |
| None | 探针消息data处理之后没有返回处理过的data，相当于把原始的data消息送给了sparkstreaming。 | 1.0.1_20180619_001 | 1.0.1_20180702_002 |

### 未修复的MR
| MR Num | 描述 | 发现的版本 |
-------- | ----------- |------ |
|None

---

# v1.0.1_20180619_001
---
## v1.0.1_20180619_001下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc.1.0.1_20180619_001.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc.1.0.1_20180619_001.tar.gz)|7a8e48768f628dc9f5be163db5c2b446404ad5e7d814326b35cc4eaa6e439422|
|[rtc.1.0.1_20180619_001_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc.1.0.1_20180619_001_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.1_20180619_001信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年6月19日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： 支持设置开关打印探针请求uri和处理完成的探针消息内容

---

## 主要更新

### 新功能

>* 添加配置项，支持设置开关打印探针请求uri和处理完成的探针消息内容。
>* 支持动态设置是否打印探针请求uri和处理完成的探针消息内容。

### 改变

>* setEnv.sh中ulimit -n的值由32768修改为1048576。

---

## Source Code

>* 说明：编译安装结构跟v1.0.0版本一样，多了一个tool工具脚本目录。

### Code结构

```
rtc                       		主目录
│  build.bat                    windows编译脚本
│  build.sh                     linux编译脚本
│  rtc_releasenotes.md    		releasenotes
│  pom.xml                      maven配置文件
├─src                           source目录
│  ├─dev                        source开发目录，开发时使用的一些代码，不会被打包。
│  ├─main                       source主目录
│  │  ├─assembly                maven 插件目录
│  │  ├─bin                     启动、停止等脚本目录
│  │  ├─config                  配置文件目录
│  │  ├─java                    java源代码目录
│  │  ├─tool                    rtc工具脚本目录
│  │  └─resources               spring配置文件目录
│  └─test                       junit测试目录
```

---

## 安装

>* 安装步骤跟V1.0.0一致，主要是配置文件rtc.yml加了打印开关的两个配置项rtc.collect.is-print.uri和rtc.collect.is-print.handled-data。一般情况下建议都设置为false，需要的时候通过工具脚本setPrintSwitch.py按需打开，用完之后再关闭。

### 配置rtc

#### rtc.yml

&emsp;&emsp;配置rtc.yml主要是4个部分。

>* rtc.http.server.address					rtc监听地址，如果是0.0.0.0则监听服务器所有ip地址
>* rtc.http.server.port						rtc监听端口
>* spring.kafka.bootstrap-servers			kafka服务器列表，以逗号分隔。例：10.50.108.10:19092,10.50.108.20:19092,10.50.108.16:19092
>* spring.kafka.rtc.topic.num-partitions	实时采集topic sparkStreaming1的分区数，一定要跟实际分区数一模一样。
>* rtc.collect.is-print.uri					是否打印请求uri
>* rtc.collect.is-print.handled-data		是否打印处理完成的探针消息

```yaml
# vi rtc.yml

#spring boot properties
#http://docs.spring.io/spring-boot/docs/1.5.9.RELEASE/reference/htmlsingle/#common-application-properties

rtc:
  collect:
    statistics:
      task:
        print-delay-seconds: 2 # 打印输出延迟秒数
        cron-expression: 0/1 * * * * ? # 打印输出统计频率，默认每秒1次
    is-print:
      uri: false # 是否在INFO日志中打印探针发送的请求URI
      handled-data: false # 是否在INFO日志中打印处理完成的探针数据
  http:
    server:
      # rtc监听IP，0.0.0.0 表示监听所有网卡端口
      address: 0.0.0.0
      # rtc监听端口
      port: 8082
      loglevel: INFO # rtc使用的netty框架日志级别，不用修改。
      thread:
          numbers:
            bossGroup: 1 # the parent (acceptor) specified number of threads
            workerGroup: 16 # the child (client) specified number of threads
      channelOption:
        soBacklog: 1024 # linux SO_BACKLOG
        connectTimeoutMills: 3000 # 连接超时时间（单位：毫秒）
      channelInitializer:
        eventExecutorGroup:
          thread:
            numbers: 256 # execute the {@link ChannelHandler} methods specified number of threads
        readTimeoutHandler:
          timeoutSeconds: 180 # read timeout in seconds
        httpObjectAggregator:
          maxContentLength: 1048576 # the maximum length of the aggregated content in bytes.
  task:
    scheduler:
      pool-size: 10 # ThreadPoolTaskScheduler pool size 

spring:
  kafka:
    # Comma-delimited list of host:port pairs to use for establishing the initial connection to the Kafka cluster.
    bootstrap-servers: 10.50.108.10:19092,10.50.108.20:19092,10.50.108.16:19092
    producer:
      batch-size: 256 # Default batch size in bytes.
      retries: 3 # When greater than zero, enables retrying of failed sends.
    listener:
      concurrency: 3 # Number of threads to run in the listener containers.
    template:
      default-topic: rtc-default # Default topic to which messages will be sent.
    topic:
      rtc:
        name: sparkStreaming1 # spark streaming实时采集kafka topic
        num-partitions: 12 # spark streaming实时采集kafka 分区数量，应该跟在kafka中创建的分区数一致。
        replication-factor: 2 # spark streaming实时采集kafka 分区复制份数，暂时没有用到。
```

---

## 升级

### From v1.0.0

>* 备份原有目录，直接全新安装。

---

## 工具

### setPrintSwitch.py

>* setPrintSwitch.py工具脚本支持动态设置打印探针请求uri和处理完成的探针消息内容。

```bash
#help
$ cd /opt/spark/rtc/tool/
$ ./setPrintSwitch.py 
2018-06-19 17:07:58,801 MainThread INFO  setPrintSwitch start to run ...
2018-06-19 17:07:58,801 MainThread INFO  please input the correct parameters:
                               isPrintUri    - whether is print requested uri? true or false
                               isPrintData   - whether is print collected data? true or false
# 设置打印请求的uri
./setPrintSwitch.py true false
# 设置打印处理完成的探针消息内容
./setPrintSwitch.py false true
# 关闭打印
./setPrintSwitch.py false false
```

---

# v1.0.0_20180615_003
---
## v1.0.0_20180615_003下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc.1.0.0_20180615_003.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc.1.0.0_20180615_003.tar.gz)|b56f99cf7f998200c4b9989bbf9b68799c966a7bf1ae03432bdd49483f4f0ea6|
|[rtc.1.0.0_20180615_003_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc.1.0.0_20180615_003_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.0_20180615_003信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年6月15日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： MR: 重庆BI探针1.0消息需要在responsbody中回复PUT_OK

---

## MR

### 修复的MR
| MR Num | 描述| 发现的版本 | 修复的版本 |
-------- | ----------- |------ | ------- |
| None | 重庆BI探针1.0消息，原来的bto + httpsqs会<br/>返回PUT_OK。因此rtc需要兼容原来的实现。 | 1.0.0_20180613_002 | 1.0.0_20180615_003 |

### 未修复的MR
| MR Num | 描述 | 发现的版本 |
-------- | ----------- |------ |
|None

---

# v1.0.0_20180613_002
---
## v1.0.0_20180613_002下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc.1.0.0_20180613_002.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc.1.0.0_20180613_002.tar.gz)|2a0a39517a06a3adbcd1b2d5b98b21badff0fb67e5631612b27518737458f3b0|
|[rtc.1.0.0_20180613_002_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc.1.0.0_20180613_002_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.0_20180613_002信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年6月13日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： 兼容探针1.0 Version

---

## 主要更新

### 新功能

>* 兼容探针1.0 Version。主要是探针发送的消息URI中缺少user_id字段。

### 改变

>* 优化日志打印。

---

# v1.0.0_20180611_001
---
## v1.0.0_20180611_001下载

| filename | sha256 hash |
| -------- | ----------- |
|[rtc.1.0.0_20180611_001.tar.gz](http://172.19.64.100:9999/release/BI/platform/2.7.2/package/RTC/rtc.1.0.0_20180611_001.tar.gz)|3edb20907ef0402050bc427acb0d32f4d8633f0145eac94edccad963a7829ec2|
|[rtc.1.0.0_20180611_001_releasenotes.html](http://172.19.64.100:9999/release/doc/releaseNotes/rtc.1.0.0_20180611_001_releasenotes.html)||
|[jdk-8u74-linux-x64.tar.gz](http://172.19.64.100:9999/release/common/JDK/jdk-8u74-linux-x64.tar.gz)|0bfd5d79f776d448efc64cb47075a52618ef76aabb31fde21c5c1018683cdddd|

---

## v1.0.0_20180611_001信息

>* Author:[Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Release Date：2018年6月11日
>* Reviewed By: [Tommy Zhao](tommy.zhao@utstarcom.cn)
>* Description Of Change： First release

---

## References

>* EPG日志采集探针接口_V3.12_20180510.doc

---

## 概述

&emsp;BI的数据采集模块，原来用的flume 1.6加上自定义httpsource来实现接收数据，写入kafka。这种方式出现问题比较难于定位，而且出包什么的也很不方便，flume 1.6已经是一个很老的版本了，也很难升级。目前在安徽BI现场就出现了flume往kafka写数据失败的问题，但是完全定位不到。因此决定用Spring Boot + Netty + Spring Kafka重新实现这个功能，除了解决原有的问题，使用Netty之后，性能也能够随之大幅提升。

---

## 主要更新

### 新功能

>* 替换原有BI的数据采集模块，即flume 1.6加上自定义httpsource来实现接收数据，写入kafka。
>* 匹配的kafka版本： kafka_2.10-0.8.2.1

### 改变

>* 首次出包，不涉及。

---

## MR

### 修复的MR
| MR Num | 描述| 发现的版本 | 修复的版本 |
-------- | ----------- |------ | ------- |
|None

### 未修复的MR
| MR Num | 描述 | 发现的版本 |
-------- | ----------- |------ |
|None

---

## Source Code

### Code结构
```
rtc                       		主目录
│  build.bat                    windows编译脚本
│  build.sh                     linux编译脚本
│  rtc_releasenotes.md    		releasenotes
│  pom.xml                      maven配置文件
├─src                           source目录
│  ├─dev                        source开发目录，开发时使用的一些代码，不会被打包。
│  ├─main                       source主目录
│  │  ├─assembly                maven 插件目录
│  │  ├─bin                     启动、停止等脚本目录
│  │  ├─config                  配置文件目录
│  │  ├─java                    java源代码目录
│  │  └─resources               spring配置文件目录
│  └─test                       junit测试目录
```
---
### 编译环境

* 编译环境要求：
    >* Windows 7或Centos6.8-x86_64
    >* JDK-8u74及以上
    >* Apache Maven 3.3.9及以上

* 编译
```bash
#windows
cd rtc.git\rtc
build.bat
#linux
cd rtc.git/rtc
chmod u+x build.sh
./build.sh
```

* 安装包

    &emsp;编译完成后，安装包位于rtc.git/rtc/target目录。

---

## 安装

### 安装JDK

>* 如果服务器上已经安装了JDK 8，则这一步可以跳过

```bash
#copy jdk-8u74-linux-x64.tar.gz to the server, unpack it
su - spark
tar xf jdk-8u74-linux-x64.tar.gz -C /opt/spark/app/
```

### 安装rtc

```bash
#copy tar xf rtc.LINUX64.MES_1.0.0_20180611_001.tar.gz to the server, unpack it
su - spark
tar xf rtc.1.0.0_20180611_001.tar.gz -C /opt/spark/
chow -R spark:hadoopgroup /opt/spark/rtc
```

### 配置rtc

&emsp;&emsp;rtc主要有三个配置文件：
>* setEnv.sh	设置JAVA_HOME
>* rtc.yml		rtc的基本配置
>* logback.xml	日志配置文件

#### setEnv.sh

>* JAVA_HOME	设置JAVA实际位置

```bash
#vi setEnv.sh

#set JAVA_HOME
JAVA_HOME=/usr/local/jdk1.8.0_74
export JAVA_HOME
JAVA="$JAVA_HOME"/bin/java

```

#### rtc.yml

&emsp;&emsp;配置rtc.yml主要是4个部分。

>* rtc.http.server.address					rtc监听地址，如果是0.0.0.0则监听服务器所有ip地址
>* rtc.http.server.port						rtc监听端口
>* spring.kafka.bootstrap-servers			kafka服务器列表，以逗号分隔。例：10.50.108.10:19092,10.50.108.20:19092,10.50.108.16:19092
>* spring.kafka.rtc.topic.num-partitions	实时采集topic sparkStreaming1的分区数，一定要跟实际分区数一模一样。

```yaml
# vi rtc.yml

#spring boot properties
#http://docs.spring.io/spring-boot/docs/1.5.9.RELEASE/reference/htmlsingle/#common-application-properties

rtc:
  collect:
    statistics:
      task:
        print-delay-seconds: 2 # 打印输出延迟秒数
        cron-expression: 0/1 * * * * ? # 打印输出统计频率，默认每秒1次
  http:
    server:
      address: 0.0.0.0
      port: 8082
      loglevel: INFO
      thread:
          numbers:
            bossGroup: 1
            workerGroup: 16
      channelOption:
        soBacklog: 1024
        connectTimeoutMills: 3000
      channelInitializer:
        eventExecutorGroup:
          thread:
            numbers: 256
        readTimeoutHandler:
          timeoutSeconds: 360
        httpObjectAggregator:
          maxContentLength: 1048576
  task:
    scheduler:
      pool-size: 10 # ThreadPoolTaskScheduler pool size 

spring:
  kafka:
    bootstrap-servers: 10.50.108.10:19092,10.50.108.20:19092,10.50.108.16:19092
    producer:
      batch-size: 100
      retries: 3
    listener:
      concurrency: 3
    template:
      default-topic: filetest
    topic:
      rtc:
        name: sparkStreaming1
        num-partitions: 12
        replication-factor: 2
```

#### logback.xml

&emsp;&emsp;日志配置文件logback.xml一般不用修改。

```xml
<?xml version="1.0" encoding="UTF-8"?>

<configuration scan="true" scanPeriod="600 seconds" debug="false">

	<property name="log_dir" value="logs" />
	<property name="maxHistory" value="720" /><!-- unit: hour -->

	<!-- LEVEL: ERROR -->
	<appender name="logError"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>${log_dir}/rtc_error.log</file>
		<filter class="ch.qos.logback.classic.filter.LevelFilter">
			<level>ERROR</level>
			<onMatch>ACCEPT</onMatch>
			<onMismatch>DENY</onMismatch>
		</filter>
		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>${log_dir}/rtc_error.log.%d{yyyy-MM-dd-HH}.%i
			</fileNamePattern>
			<maxHistory>${maxHistory}</maxHistory>
			<cleanHistoryOnStart>true</cleanHistoryOnStart>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
		<encoder>
			<pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p [%t] [%c] - %m%n</pattern>
		</encoder>
	</appender>

	<!-- LEVEL: WARN -->
	<appender name="logWarn"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>${log_dir}/rtc_warn.log</file>
		<filter class="ch.qos.logback.classic.filter.LevelFilter">
			<level>WARN</level>
			<onMatch>ACCEPT</onMatch>
			<onMismatch>DENY</onMismatch>
		</filter>
		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>${log_dir}/rtc_warn.log.%d{yyyy-MM-dd-HH}.%i
			</fileNamePattern>
			<maxHistory>${maxHistory}</maxHistory>
			<cleanHistoryOnStart>true</cleanHistoryOnStart>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
		<encoder>
			<pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p [%t] [%c] - %m%n</pattern>
		</encoder>
	</appender>

	<!-- LEVEL: INFO -->
	<appender name="logInfo"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>${log_dir}/rtc.log</file>
		<filter class="ch.qos.logback.classic.filter.LevelFilter">
			<level>INFO</level>
			<onMatch>ACCEPT</onMatch>
			<onMismatch>DENY</onMismatch>
		</filter>
		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>${log_dir}/rtc.log.%d{yyyy-MM-dd-HH}.%i
			</fileNamePattern>
			<maxHistory>${maxHistory}</maxHistory>
			<cleanHistoryOnStart>true</cleanHistoryOnStart>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
		<encoder>
			<pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] - %m%n</pattern>
		</encoder>
	</appender>

	<!-- LEVEL: DEBUG -->
	<appender name="logDebug"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>${log_dir}/rtc_debug.log</file>
		<filter class="ch.qos.logback.classic.filter.LevelFilter">
			<level>DEBUG</level>
			<onMatch>ACCEPT</onMatch>
			<onMismatch>DENY</onMismatch>
		</filter>
		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>${log_dir}/rtc_debug.log.%d{yyyy-MM-dd-HH}.%i
			</fileNamePattern>
			<maxHistory>${maxHistory}</maxHistory>
			<cleanHistoryOnStart>true</cleanHistoryOnStart>
			<timeBasedFileNamingAndTriggeringPolicy
				class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
				<maxFileSize>10MB</maxFileSize>
			</timeBasedFileNamingAndTriggeringPolicy>
		</rollingPolicy>
		<encoder>
			<pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p [%t] [%c] - %m%n</pattern>
		</encoder>
	</appender>

	<!-- package: cn.utstarcom.rtc -->
	<logger name="cn.utstarcom.rtc" level="INFO" />

	<!-- package: org.springframework -->
	<logger name="org.springframework" level="INFO" />
	
	<!-- package: io.netty -->
    <logger name="io.netty" level="INFO" />
    
    <!-- package: org.apache.kafka -->
    <logger name="org.apache.kafka" level="INFO" />
    
    <!-- package: jboss logging log exception handle -->
    <logger name="INFO" level="WARN"/>

	<!-- root -->
	<root level="DEBUG">
		<appender-ref ref="logError" />
		<appender-ref ref="logWarn" />
		<appender-ref ref="logInfo" />
		<appender-ref ref="logDebug" />
	</root>

</configuration>
```

### 启动

```bash
#启动
su - spark
cd /opt/spark/rtc/bin
nohup ./start_rtc.sh &

#检查
# tail -f nohup.out 

20180611-152019 - [start_rtc.sh]: start to run rtc.
20180611-152019 - [start_rtc.sh]: run rtc_monitor.py script.
20180611-152019 - [start_rtc.sh]: run rtc main program.
20180611-152019 - [start_rtc.sh]: rtc used memory size: 512M
15:20:19.805 [main] INFO cn.utstarcom.rtc.RtcApplication - the rtc begin to start ....
2018-06-11 15:20:20,179 root     INFO  start to run rtc_monitor.
2018-06-11 15:20:20,179 root     INFO  first, sleep 300 seconds...

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::       (v1.5.10.RELEASE)

2018-06-11 15:20:22,192 - [HttpServerImpl]: netty http server bind: http://0.0.0.0:19099 started success!
2018-06-11 15:20:22,325 - [RtcApplication]: the rtc start completed. the user dir: /opt/spark/rtc
```

---

## PROTOCOL CHART
| Tcp/Udp | Protocol Type | Port# TO: | Description
| -------- | ----------- | ------ | ------- |
| TCP | HTTP | 8082 | 对外提供服务接口。可修改，以现场为准。 |